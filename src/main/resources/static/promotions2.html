<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PromoWS - Promoções em Slide</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>

<div id="status" class="status disconnected">Desconectado</div>
<button id="reconnect-btn">Reconectar</button>
<div id="department-selector">
    <select id="department-select">
        <option value="AÇOUGUE">Açougue</option>
        <option value="PADARIA">Padaria</option>
        <option value="HORTIFRUTI">Hortifruti</option>
        <option value="LATICINIOS">Laticínios</option>
        <option value="BEBIDAS">Bebidas</option>
        <option value="LIMPEZA">Limpeza</option>
    </select>
</div>
<button id="fullscreen-btn">TELA CHEIA</button>

<div id="welcome-message">Seja bem-vindo!<br>Fique atento às nossas promoções</div>

<div id="slider"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<!-- Adicione isto ANTES do stomp.js -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>

<script>
    // Lê configurações do servidor
    let serverAddress = null;
    let serverPort = null;
    let socketEndpoint = null;
    loadConfig();

    const promotionsTopic = "/topic/promotions";
    const defaultImage = "https://cdn.pixabay.com/photo/2018/08/30/14/46/food-3642376_1280.jpg";

    // Elementos da DOM
    const statusElement = document.getElementById('status');
    const slider = document.getElementById('slider');
    const reconnectBtn = document.getElementById('reconnect-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const welcomeMessage = document.getElementById('welcome-message');
    const departmentSelect = document.getElementById('department-select');

    // Variáveis globais
    let stompClient = null;
    let currentSlide = 0;
    const slideInterval = 8000;
    let mouseTimeout;
    const hideDelay = 3000;
    let isFullscreen = false;
    let selectedDepartment = departmentSelect.value;
    let activePromotionIds = new Set();
    let slideIntervalId = null;

    // 1. FUNÇÕES DE FULLSCREEN ==============================================
    function toggleFullscreen() {
      if (!isFullscreen) {
        enterFullscreen();
      } else {
        exitFullscreen();
      }
    }

    function enterFullscreen() {
      const element = document.documentElement;

      if (element.requestFullscreen) {
        element.requestFullscreen().then(() => {
          isFullscreen = true;
          hideControls();
        }).catch(err => {
          console.error("Erro ao entrar em tela cheia:", err);
          showFullscreenButton();
        });
      } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
      } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen();
      } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
      }
    }

    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      isFullscreen = false;
      showControls();
    }

    function showFullscreenButton() {
      fullscreenBtn.style.display = 'block';
      fullscreenBtn.textContent = 'TELA CHEIA';
    }

    function hideFullscreenButton() {
      fullscreenBtn.style.display = 'none';
    }

    function hideControls() {
      statusElement.classList.add('controls-hidden');
      reconnectBtn.classList.add('controls-hidden');
      fullscreenBtn.classList.add('controls-hidden');
      document.getElementById('department-selector').classList.add('controls-hidden');
    }

    function showControls() {
      statusElement.classList.remove('controls-hidden');
      reconnectBtn.classList.remove('controls-hidden');
      fullscreenBtn.classList.remove('controls-hidden');
      document.getElementById('department-selector').classList.remove('controls-hidden');
    }

    function handleMouseMove() {
      if (isFullscreen) {
        showControls();
        resetHideTimeout();
      }
    }

    function resetHideTimeout() {
      clearTimeout(mouseTimeout);
      mouseTimeout = setTimeout(() => {
        if (isFullscreen) {
          hideControls();
        }
      }, hideDelay);
    }

    // Event listeners para fullscreen
    fullscreenBtn.addEventListener('click', toggleFullscreen);

    document.addEventListener('fullscreenchange', () => {
      isFullscreen = !!document.fullscreenElement;
      if (isFullscreen) {
        document.addEventListener('mousemove', handleMouseMove);
        resetHideTimeout();
      } else {
        document.removeEventListener('mousemove', handleMouseMove);
        clearTimeout(mouseTimeout);
        showControls();
      }
    });

    // 2. FUNÇÕES DO SLIDE ==================================================
    function showPromotionSlide(promotion) {
      
      // Verifica se a promoção é do departamento selecionado e se não está ativa
      if (promotion.departament.departamentName.replace(/[^a-zA-Z0-9\s]/g, '').toUpperCase() === selectedDepartment &&
          !activePromotionIds.has(promotion.id)) {

        activePromotionIds.add(promotion.id);
        welcomeMessage.style.display = 'none';

        const slide = document.createElement('div');
        slide.className = 'slide promotion-slide';
        slide.dataset.promotionId = promotion.id;

        // Usa a imagem padrão inicialmente
        slide.style.backgroundImage = `url('${defaultImage}')`;

        // Tenta carregar a imagem da promoção em segundo plano
        if (promotion.imageUrl) {
          const img = new Image();
          img.src = promotion.imageUrl;
          img.onload = function() {
            slide.style.backgroundImage = `url('${promotion.imageUrl}')`;
          };
          img.onerror = function() {
            console.error("Erro ao carregar imagem:", promotion.imageUrl);
          };
        }

        slide.innerHTML = `
          <div class="promotion-card">
            <h2>${promotion.productName || 'Produto não especificado'}</h2>
            <p><strong>de R$:</strong> <originalPrice>${(promotion.originalPrice || 0).toFixed(2)} </originalPrice></p>
            <p><strong>por R$:</strong> <promotionalPrice>${(promotion.promotionalPrice || 0).toFixed(2)} </promotionalPrice></p>
            <p><strong>Promoção válida até:</strong> ${promotion.expirationDate ? new Date(promotion.expirationDate).toLocaleDateString('pt-BR') : 'N/A'}</p>
          </div>
        `;

        slider.appendChild(slide);

        // Se for o primeiro slide, inicie o slideshow
        if (document.querySelectorAll('.slide').length === 1) {
          startSlideShow();
          slide.classList.add('active');
          currentSlide = 0;
        }
      }
    }

    function startSlideShow() {
      if (!slideIntervalId) {
        slideIntervalId = setInterval(updateSlideShow, slideInterval);
      }
    }

    function stopSlideShow() {
      if (slideIntervalId) {
        clearInterval(slideIntervalId);
        slideIntervalId = null;
      }
    }

    function updateSlideShow() {
      const slides = document.querySelectorAll('.slide');

      if (slides.length === 0) {
        welcomeMessage.style.display = 'flex';
        activePromotionIds.clear();
        stopSlideShow();
        return;
      }

      welcomeMessage.style.display = 'none';

      // Atualiza o conjunto de IDs ativos
      const currentIds = new Set();
      slides.forEach(slide => {
        currentIds.add(slide.dataset.promotionId);
      });

      // Remove IDs que não estão mais nos slides
      activePromotionIds.forEach(id => {
        if (!currentIds.has(id)) {
          activePromotionIds.delete(id);
        }
      });

      slides.forEach((slide, index) => {
        slide.classList.remove('active');
        if (index === currentSlide) {
          slide.classList.add('active');
        }
      });

      currentSlide = (currentSlide + 1) % slides.length;
    }

        // 3. FUNÇÕES DE CONEXÃO WEBSOCKET =====================================
    function setStatus(status, message) {
      statusElement.textContent = message;
      statusElement.className = `status ${status}`;
      console.log(`Status: ${status} - ${message}`);
    }

    function loadConfig() {
        fetch('/api/config')
            .then(response => response.json())
            .then(config => {
                serverAddress = config.serverAddress;
                serverPort = config.serverPort;
                socketEndpoint = `ws://${serverAddress}:${serverPort}/ws-promotions`;
            })
            .catch(error => {
                console.error("Erro ao carregar configurações:", error);
                serverAddress = window.location.hostname;
                serverPort = window.location.port || '9090';
                socketEndpoint = `ws://${serverAddress}:${serverPort}/ws-promotions`;
            });
    }

    function loadExistingPromotions() {
        return fetch('/api/promotions')
            .then(response => {
                if (!response.ok) throw new Error('Erro ao carregar promoções');
                return response.json();
            })
            .then(promotions => {
                promotions.forEach(promotion => {
                    showPromotionSlide(promotion);
                });
            })
            .catch(error => {
                console.error('Erro ao carregar promoções existentes:', error);
            });
    }

    async function loadDepartments() {
        try {
            const response = await fetch('/api/departaments');
            if (!response.ok) {
                throw new Error('Erro ao carregar departamentos');
            }
            const departments = await response.json();
            populateDepartmentSelect(departments);
        } catch (error) {
            console.error('Falha ao carregar departamentos:', error);
            // Você pode adicionar um fallback com departamentos padrão se quiser
        }
    }

    function populateDepartmentSelect(departments) {
        const select = document.getElementById('department-select');
        select.innerHTML = ''; // Limpa as opções existentes

        // Ordena os departamentos por nome (opcional)
        departments.sort((a, b) => a.departamentName.localeCompare(b.departamentName));

        // Adiciona cada departamento como uma opção
        departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.id; // Usando o ID como valor
            option.textContent = dept.departamentName;
            select.appendChild(option);
        });

        // Atualiza a variável selectedDepartment com o primeiro valor
        if (departments.length > 0) {
            selectedDepartment = departments[0].id.toString();
        }
    }

    function connect() {
        setStatus("connecting", "Conectando...");
        reconnectBtn.style.display = 'none';

        // Desconecta se já estiver conectado
        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }

        // Limpa o slider
        slider.innerHTML = '';
        activePromotionIds.clear();
        welcomeMessage.style.display = 'flex';

        // Cria nova conexão
        const socket = new SockJS(socketEndpoint);
        stompClient = Stomp.over(socket);

        stompClient.reconnect_delay = 5000;
        stompClient.heartbeatIncoming = 4000;
        stompClient.heartbeatOutgoing = 4000;

        // Desativa logs de debug (opcional)
        stompClient.debug = () => {};

        stompClient.connect({}, function(frame) {
            // Conexão bem sucedida
            setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
            reconnectBtn.style.display = 'none';

            // Carrega promoções existentes
            loadExistingPromotions().then(() => {
                console.log('Promoções carregadas com sucesso');
            });

            // Assina o tópico de promoções
            stompClient.subscribe(promotionsTopic, function(message) {
                try {
                    const promotion = JSON.parse(message.body);
                    showPromotionSlide(promotion);
                } catch (e) {
                    console.error("Erro ao processar mensagem:", e);
                }
            });

        }, function(error) {
            console.error("Erro na conexão:", error);
            setStatus("disconnected", "Falha na conexão");
            reconnectBtn.style.display = 'block';

            // Tentar reconectar após 5 segundos
            setTimeout(connect, 5000);
        });
    }

    // 4. INICIALIZAÇÃO =====================================================
    window.addEventListener('load', function() {
        // Configurar listener para mudança de departamento
        departmentSelect.addEventListener('change', function() {
            selectedDepartment = this.value;
            slider.innerHTML = '';
            activePromotionIds.clear();
            welcomeMessage.style.display = 'flex';



            // Atualiza o status durante a mudança
            if (stompClient && stompClient.connected) {
                setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
            } else {
                setStatus("connecting", "Conectando...");
            }

            loadExistingPromotions().then(() => {
                setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
                });
            });

            //setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);

       // Carrega configurações e inicia conexão-->
       //loadConfig();-->
       //connect();-->


        // Mostrar botão de fullscreen inicialmente
        showFullscreenButton();

        // Tentar entrar em fullscreen após pequeno delay
        setTimeout(() => {
            if (!document.fullscreenElement) {
                enterFullscreen();
            }
        }, 1000);
    });

    window.addEventListener('beforeunload', function() {
        if (stompClient) {
            stompClient.disconnect();
        }
    });

    reconnectBtn.addEventListener('click', function() {
        connect();
    });

    
</script>
</body>
</html>
