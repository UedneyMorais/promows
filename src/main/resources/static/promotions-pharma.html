<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromoWS - Promoções em Slide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=Poppins&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">


    <style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  height: 100%;
  font-family: 'Roboto', sans-serif;
  background: linear-gradient(to right, #e8f5e9, #ffffff);
  color: #212121;
}

.status {
  position: absolute;
  top: 10px;
  left: 10px;
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 1000;
  background-color: rgba(33, 150, 83, 0.8);
  color: white;
}

.connected { background-color: rgba(56, 142, 60, 0.85); }
.disconnected { background-color: rgba(211, 47, 47, 0.85); }
.connecting { background-color: rgba(255, 160, 0, 0.85); }

#reconnect-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 10px 20px;
  background-color: #2e7d32;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  z-index: 1000;
  display: none;
}

#department-selector {
  position: absolute;
  top: 60px;
  left: 10px;
  padding: 10px;
  background-color: rgba(255,255,255,0.9);
  border: 1px solid #ccc;
  border-radius: 8px;
  z-index: 1000;
}

#department-selector select {
  padding: 8px 12px;
  font-size: 16px;
  border-radius: 5px;
  border: 1px solid #ccc;
  background-color: #f9f9f9;
  color: #333;
}

#goto-menu {
  position: fixed;
  top: 10px;
  left: 200px;
  padding: 8px 15px;
  border: none;
  border-radius: 20px;
  background-color: #0b4aa8;
  color: white;
  font-weight: bold;
  cursor: pointer;
  z-index: 1000;
}

#slider {
  width: 100%;
  height: 100%;
  position: relative;
}

.slide {
  position: absolute;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  transition: opacity 1s ease-in-out;
  opacity: 0;
}

.slide.active {
  opacity: 1;
  z-index: 1;
}

.promotion-card {
  width: 90%;
  height: 90%;
  box-sizing: border-box;
  padding: 4vh 5vw;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  text-align: center;
  overflow: hidden;
}

.promotion-card h2 {
  font-size: 10vmin;
  margin: 2vh 0 1vh;
  color: #0b4aa8;
  font-weight: 700;
  font-family: 'Roboto', sans-serif;
  line-height: 1.1;
}

.promotion-card originalPrice {
  font-size: 5vmin;
  margin: 1vh 0;
  color: #888;
  text-decoration: line-through;
  font-weight: 400;
}

.promotion-card promotionalPrice {
  font-size: 14vmin;
  margin: 1vh 0;
  color: #d32f2f;
  font-weight: 800;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

.promotion-card .department {
  font-size: 4vmin;
  color: #0b4aa8;
  margin-bottom: 2vh;
}

.promotion-card p {
  font-size: 4vmin;
  margin: 1vh 0;
  max-width: 100%;
  word-break: break-word;
}

#fullscreen-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 14px 22px;
  background-color: #0b4aa8;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  z-index: 1000;
  font-size: 18px;
  font-weight: bold;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

#fullscreen-btn:hover {
  background-color: #4caf50;
}

#welcome-message {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: rgba(255, 255, 255, 0.9);
  z-index: 10;
  font-size: 9vmin;
  color: #388e3c;
  font-weight: 600;
  padding: 20px;
  text-align: center;
}

.slide-progress {
  position: fixed;
  bottom: 30px;
  left: 30px;
  width: 50px;
  height: 50px;
  z-index: 1000;
}

.progress-circle {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.progress-circle-bg {
  fill: none;
  stroke: #e0e0e0;
  stroke-width: 4;
}

.progress-circle-fill {
  fill: none;
  stroke: #43a047;
  stroke-width: 4;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.1s linear;
}

body.fullscreen-no-cursor {
  cursor: none;
}

.controls-hidden {
  opacity: 0 !important;
  pointer-events: none !important;
}

.client-logo {
  margin-top: 1vh;
  display: flex;
  justify-content: flex-start; /* <- Alinha à esquerda */
  align-items: center;
  width: 100%;
  padding-left: 2vw; /* Pequeno recuo da borda */
}

.client-logo img {
  max-height: 32vmin; /* ou outro valor desejado */
  max-width: 60vw;
  object-fit: contain;
  opacity: 0.95;
}

.client-logo-bg {
  position: absolute;
  top: 70%;
  left: 20%;
  transform: translate(-50%, -50%);
  opacity: 0.8;
  z-index: 0;
  pointer-events: none;
}

.client-logo-bg img {
  max-width: 60%;
  max-height: 60%;
  object-fit: contain;
}

</style>


</head>
<body>
    <div id="status" class="status disconnected">Desconectado</div>
    <button id="reconnect-btn">Reconectar</button>
    <div id="department-selector">
        <div id="department-loading">Carregando departamentos...</div>
        <select id="department-select" style="display: none;"></select>
    </div>
    <button id="goto-menu">Menu</button>
    <button id="fullscreen-btn">TELA CHEIA</button>
    <div id="welcome-message">Seja bem-vindo!<br>Fique atento às nossas promoções</div>
    <div id="slider"></div>
    
    <!-- Contador de progresso circular -->
    <div class="slide-progress">
        <svg class="progress-circle" viewBox="0 0 36 36">
            <circle class="progress-circle-bg" cx="18" cy="18" r="16"></circle>
            <circle class="progress-circle-fill" cx="18" cy="18" r="16" stroke-dasharray="100 100" stroke-dashoffset="0"></circle>
        </svg>
    </div>


    <!-- Bibliotecas externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script>
        // ============= CONFIGURAÇÕES GLOBAIS =============
        const serverAddress = window.location.hostname;
        const serverPort = window.location.port || '9090';
        //Com Websocket sem SOckJs
        //const socketEndpoint = `ws://${serverAddress}:${serverPort}/ws-promotions`;
        const socketEndpoint = `/ws-promotions`;

        const promotionsTopic = "/topic/promotions";
        //const deletedPromotionsTopic = "/topic/deleted-promotions";
        const defaultImage = "https://cdn.pixabay.com/photo/2018/08/30/14/46/food-3642376_1280.jpg";

        // ============= ELEMENTOS DOM =============
        const elements = {
            status: document.getElementById('status'),
            menuBtn: document.getElementById('goto-menu'),
            slider: document.getElementById('slider'),
            reconnectBtn: document.getElementById('reconnect-btn'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            welcomeMessage: document.getElementById('welcome-message'),
            departmentSelect: document.getElementById('department-select'),
            departmentLoading: document.getElementById('department-loading'),
            progressCircle: document.querySelector('.progress-circle-fill')
        };

        // ============= ESTADO GLOBAL =============
        const state = {
            stompClient: null,
            currentSlide: 0,
            slideIntervalId: null,
            progressIntervalId: null,
            isFullscreen: false,
            selectedDepartment: null,
            activePromotionIds: new Set(),
            slideInterval: 8000, // 8 segundos
            hideDelay: 3000,
            mouseTimeout: null,
            timeLeft: 0,
            circumference: 2 * Math.PI * 16 // Circunferência do círculo (2πr)
        };


        // ============= VARIÁVEIS GLOBAIS =============
        let stompClient = null;
        let currentSlide = 0;
        const slideInterval = 8000; // Intervalo entre slides (8 segundos)
        let mouseTimeout;
        const hideDelay = 3000; // Tempo para esconder controles em tela cheia
        let isFullscreen = false;
        let selectedDepartment = null;
        let activePromotionIds = new Set(); // Armazena IDs de promoções ativas
        let slideIntervalId = null;

        // ============= FUNÇÕES AUXILIARES =============
        function formatDepartmentName(name) {
            return name
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^a-zA-Z\s]/g, '') // Remove caracteres especiais
                .toUpperCase(); // Padroniza para maiúsculas
        }

        function setStatus(status, message) {
            elements.status.textContent = message;
            elements.status.className = `status ${status}`;
        }

        function resetSlider() {
            document.querySelectorAll('.slide').forEach(slide => slide.remove());
            state.activePromotionIds.clear();
            elements.welcomeMessage.style.display = 'flex';
            state.currentSlide = 0;
            stopSlideShow();
        }

        async function loadDepartments() {
            try {
                const response = await fetch('/api/departments');
                if (!response.ok) throw new Error('Erro na API');
                
                const departments = await response.json();
                elements.departmentSelect.innerHTML = '';
                elements.departmentSelect.add(new Option('Todos os Departamentos', 'ALL'));
                
                departments.forEach(dept => {
                    const option = new Option(dept.departmentName, formatDepartmentName(dept.departmentName));
                    elements.departmentSelect.add(option);
                });

                elements.departmentLoading.style.display = 'none';
                elements.departmentSelect.style.display = 'block';
                state.selectedDepartment = elements.departmentSelect.value;

            } catch (error) {
                console.error('Erro ao carregar departamentos:', error);
                // Fallback básico
                elements.departmentSelect.innerHTML = `
                    <option value="ALL">Todos os Departamentos</option>
                    <option value="PADARIA">Padaria</option>
                    <option value="ACOUGUE">Açougue</option>
                `;
                elements.departmentLoading.style.display = 'none';
                elements.departmentSelect.style.display = 'block';
                state.selectedDepartment = "ALL";
            }
        }

        async function loadValidPromotions() {
            try {

                await fetch('/api/promotions/valid');
                // const response = await fetch('/api/promotions/valid');
                // if (!response.ok) throw new Error('Erro ao carregar promoções');
                
                // const promotions = await response.json();
                // promotions.forEach(promotion => console.log(promotion));


                // // promotions.filter(promotion => isPromotionValid(promotion))
                // promotions.forEach(promotion => showPromotionSlide(promotion));
            } catch (error) {
                console.error('Erro ao carregar promoções:', error);
            }
        }

        function showPromotionSlide(promotions) {
            //if (!isPromotionValid(promotion)) return;
            
            if(promotions){

                resetSlider();


                promotions.forEach(promotion => {
                    const promoDept = formatDepartmentName(promotion.department.departmentName);
                    const shouldShow = state.selectedDepartment === 'ALL' || promoDept === state.selectedDepartment;

                    if (shouldShow && !state.activePromotionIds.has(promotion.id)) {
                        state.activePromotionIds.add(promotion.id);
                        elements.welcomeMessage.style.display = 'none';

                        const slide = document.createElement('div');
                        slide.className = 'slide';
                        slide.dataset.promotionId = promotion.id;
                        slide.style.backgroundImage = `url('${promotion.imageUrl || defaultImage}')`;

                        slide.innerHTML = `
                            <div class="promotion-card">
                                <h2>${promotion.productName || 'Promoção'}</h2>
                                <p><strong>de R$:</strong> <originalPrice>${(promotion.originalPrice || 0).toFixed(2).replace('.', ',')} </originalPrice></p>
                                <p><strong>por R$:</strong> <promotionalPrice> ${(promotion.promotionalPrice || 0).toFixed(2).replace('.', ',') }</promotionalPrice></p>
                                
                                <div class="client-logo-bg">
                                    <img src="/images/logo.png" alt="Logo Cliente">
                                </div>
                                ${promotion.expirationDate ? `<p><strong>Válido até:</strong> ${new Date(promotion.expirationDate).toLocaleDateString('pt-BR')}</p>` : ''}
                            </div>

                        `;

                        elements.slider.appendChild(slide);
                        
                        if (document.querySelectorAll('.slide').length === 1) {
                            startSlideShow();
                            slide.classList.add('active');
                            state.currentSlide = 0;
                        }
                    }
            })
            }
        }

        function startSlideShow() {
            if (!state.slideIntervalId) {
                // Configura o círculo de progresso
                elements.progressCircle.style.strokeDasharray = state.circumference;
                updateProgressCircle(100);
                state.timeLeft = state.slideInterval / 1000; // Converte para segundos

                // Atualiza o contador a cada 100ms
                state.progressIntervalId = setInterval(() => {
                    state.timeLeft -= 0.1;
                    const progress = (state.timeLeft / (state.slideInterval / 1000)) * 100;
                    updateProgressCircle(progress);
                }, 100);

                state.slideIntervalId = setInterval(() => {
                    updateSlideShow();
                    state.timeLeft = state.slideInterval / 1000; // Reseta o contador
                    updateProgressCircle(100);
                }, state.slideInterval);
            }
        }

        function updateSlideShow() {
            const slides = document.querySelectorAll('.slide');

            if (slides.length === 0) {
                elements.welcomeMessage.style.display = 'flex';
                stopSlideShow();
                return;
            }
            slides.forEach(slide => slide.classList.remove('active'));
            state.currentSlide = (state.currentSlide + 1) % slides.length;
            slides[state.currentSlide].classList.add('active');
        }

        function stopSlideShow() {
            if (state.slideIntervalId) {
                clearInterval(state.slideIntervalId);
                clearInterval(state.progressIntervalId);
                state.slideIntervalId = null;
                state.progressIntervalId = null;
                updateProgressCircle(100); // Volta ao completo
            }
        }

        function updateProgressCircle(percent) {
            const offset = state.circumference - (percent / 100) * state.circumference;
            elements.progressCircle.style.strokeDashoffset = offset;

            // Muda a cor quando está perto de acabar
            if (percent < 20) {
                elements.progressCircle.style.stroke = '#f44336';
            } else {
                elements.progressCircle.style.stroke = '#2196F3';
            }
        }

        // ============= FUNÇÕES DE TELA CHEIA =============    

        /** Alterna entre tela cheia e normal */
        function toggleFullscreen() {
                if (!state.isFullscreen) {
                    document.documentElement.requestFullscreen()
                        .then(() => {
                            state.isFullscreen = true;
                            document.addEventListener('mousemove', handleMouseMove);
                            resetHideTimeout();
                        })
                        .catch(err => {
                            console.error("Erro ao entrar em tela cheia:", err);
                        });
                } else {
                    document.exitFullscreen();
                }
        }

        /** Entra em modo tela cheia */
        function enterFullscreen() {
            const element = document.documentElement;
            if (element.requestFullscreen) {
                element.requestFullscreen()
                    .then(() => {
                        isFullscreen = true;
                        hideControls();
                    })
                    .catch(err => {
                        console.error("Erro ao entrar em tela cheia:", err);
                        showFullscreenButton();
                    });
            }
        }

        /** Sai do modo tela cheia */
        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
            isFullscreen = false;
            showControls();
        }

        /** Mostra o botão de tela cheia */
        function showFullscreenButton() {
            fullscreenBtn.style.display = 'block';
            fullscreenBtn.textContent = 'TELA CHEIA';
        }

        /** Esconde o botão de tela cheia */
        function hideFullscreenButton() {
            fullscreenBtn.style.display = 'none';
        }

        /** Esconde os controles na tela cheia */
        function hideControls() {
            const controls = [
                elements.status,
                elements.reconnectBtn,
                elements.fullscreenBtn,
                elements.menuBtn,
                document.getElementById('department-selector'),
                document.querySelector('.slide-progress')
            ];
            
            controls.forEach(control => {
                if (control) control.classList.add('controls-hidden');
            });
    
            // Esconde o cursor do mouse
            document.body.classList.add('fullscreen-no-cursor');
        }

        /** Mostra os controles na tela cheia */
        function showControls() {
        const controls = [
            elements.status,
            elements.reconnectBtn,
            elements.fullscreenBtn,
            elements.menuBtn,
            document.getElementById('department-selector'),
            document.querySelector('.slide-progress')
        ];
        
        controls.forEach(control => {
            if (control) control.classList.remove('controls-hidden');
        });
        // Mostra o cursor do mouse
         document.body.classList.remove('fullscreen-no-cursor');
    }

    function handleMouseMove() {
        if (state.isFullscreen) {
            showControls();
            resetHideTimeout();
        }
    }

    function resetHideTimeout() {
        //clearTimeout(state.mouseTimeout);
        state.mouseTimeout = setTimeout(() => {
            if (state.isFullscreen) {
                hideControls();
            }
        }, state.hideDelay);
    }

    // ============= WEBSOCKET =============
        function connect(){
            setStatus("connecting", "Conectando...");

            if (state.stompClient && state.stompClient.connected) {
                state.stompClient.disconnect();
            }

            //const socket = new WebSocket(socketEndpoint);
            const socket = new SockJS(socketEndpoint);
            state.stompClient = Stomp.over(socket);
            state.stompClient.debug = () => {};

            state.stompClient.connect({}, () => {
                setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
                loadValidPromotions();

                state.stompClient.subscribe(promotionsTopic, message => {
                    try {
                        const promotion = JSON.parse(message.body);
                        // if (isPromotionValid(promotion)) {
                        //     showPromotionSlide(promotion);
                        // }
                        //resetSlider();
                        

                        showPromotionSlide(promotion);
                    } catch (e) {
                        console.error("Erro ao processar mensagem:", e);
                    }
                });
            }, (error) => {
                console.error('Erro de conexão: ', error);
                setStatus("disconnected", "Desconectado");
                setTimeout(connect, 5000);
            });

        }

    // ============= INICIALIZAÇÃO =============
    window.addEventListener('load', async () => {

        await loadDepartments();
            
        elements.departmentSelect.addEventListener('change', () => {
            state.selectedDepartment = elements.departmentSelect.value;
            resetSlider();
            if (state.stompClient?.connected) loadValidPromotions();
        })  

        elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
        //elements.reconnectBtn.addEventListener('click', connect);
        elements.menuBtn.addEventListener('click', () => {
            window.location.href = '/promotions/list-promotions.html';
        })  

        connect();
    });
 
    </script>
</body>
</html>