<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PromoWS - Promoções em Slide</title>
    <link rel="stylesheet" href="./css/promotions/styles-promotions.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=Poppins&display=swap" rel="stylesheet">
    <style>
        /* Estilos adicionais para garantir visibilidade */
        .status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
        }
        
        .connected {
            background-color: #4CAF50;
            color: white;
        }
        
        .disconnected {
            background-color: #f44336;
            color: white;
        }
        
        .connecting {
            background-color: #FFC107;
            color: black;
        }
        
        .controls-hidden {
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        #fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
        
        #department-selector {
            position: fixed;
            top: 50px;
            left: 10px;
            z-index: 1000;
        }
        
        #reconnect-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            background-color: #9E9E9E;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>

<div id="status" class="status disconnected">Desconectado</div>
<button id="reconnect-btn">Reconectar</button>
<div id="department-selector">
    <div id="department-loading">Carregando departamentos...</div>
    <select id="department-select" style="display: none;"></select>
</div>
<button id="fullscreen-btn">TELA CHEIA</button>

<div id="welcome-message">Seja bem-vindo!<br>Fique atento às nossas promoções</div>

<div id="slider"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>

<script>
    // Configurações
    const serverAddress = window.location.hostname;
    const serverPort = window.location.port || '9090';
    let socketEndpoint = `ws://${serverAddress}:${serverPort}/ws-promotions`;
    const promotionsTopic = "/topic/promotions";
    const defaultImage = "https://cdn.pixabay.com/photo/2018/08/30/14/46/food-3642376_1280.jpg";

    // Elementos DOM
    const statusElement = document.getElementById('status');
    const slider = document.getElementById('slider');
    const reconnectBtn = document.getElementById('reconnect-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const welcomeMessage = document.getElementById('welcome-message');
    const departmentSelect = document.getElementById('department-select');
    const departmentLoading = document.getElementById('department-loading');

    // Variáveis globais
    let stompClient = null;
    let currentSlide = 0;
    const slideInterval = 8000;
    let mouseTimeout;
    const hideDelay = 3000;
    let isFullscreen = false;
    let selectedDepartment = null;
    let activePromotionIds = new Set();
    let slideIntervalId = null;

    // Funções auxiliares
    function formatDepartmentName(name) {
        return name
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-zA-Z\s]/g, '')
            .toUpperCase();
    }

    function resetSlider() {
        const slides = document.querySelectorAll('.slide');
        slides.forEach(slide => slide.remove());
        activePromotionIds.clear();
        welcomeMessage.style.display = 'flex';
        currentSlide = 0;
        stopSlideShow();
    }

    async function loadDepartments() {
        try {
            const response = await fetch('/api/departments');
            if (!response.ok) throw new Error('Erro na API');
            const departments = await response.json();

            departmentSelect.innerHTML = '';
            
            // Adiciona opção "Todos os Departamentos"
            const allOption = new Option('Todos os Departamentos', 'ALL');
            departmentSelect.add(allOption);
            
            departments.forEach(dept => {
                const formattedValue = formatDepartmentName(dept.departmentName);
                const option = new Option(dept.departmentName, formattedValue);
                departmentSelect.add(option);
            });

            departmentLoading.style.display = 'none';
            departmentSelect.style.display = 'block';
            selectedDepartment = departmentSelect.value;

        } catch (error) {
            console.error('Erro ao carregar departamentos:', error);
            departmentSelect.innerHTML = `
                <option value="ALL">Todos os Departamentos</option>
                <option value="PADARIA">Padaria</option>
                <option value="ACOUGUE">Açougue</option>
                <option value="HORTIFRUTI">Hortifruti</option>
            `;
            departmentLoading.style.display = 'none';
            departmentSelect.style.display = 'block';
            selectedDepartment = "ALL";
        }
    }

    // Funções de slide
    function showPromotionSlide(promotion) {
        const promoDeptFormatted = formatDepartmentName(promotion.department.departmentName);
        
        // Verifica se a promoção já existe no slider
        const existingSlide = document.querySelector(`.slide[data-promotion-id="${promotion.id}"]`);
        
        // Verifica se a promoção pertence ao departamento selecionado ou se "Todos" está selecionado
        const departmentMatch = (selectedDepartment === 'ALL') || (promoDeptFormatted === selectedDepartment);
        
        if (departmentMatch && !existingSlide) {
            activePromotionIds.add(promotion.id);
            welcomeMessage.style.display = 'none';

            const slide = document.createElement('div');
            slide.className = 'slide promotion-slide';
            slide.dataset.promotionId = promotion.id;
            slide.style.backgroundImage = `url('${defaultImage}')`;

            if (promotion.imageUrl) {
                const img = new Image();
                img.src = promotion.imageUrl;
                img.onload = function() {
                    slide.style.backgroundImage = `url('${promotion.imageUrl}')`;
                };
                img.onerror = function() {
                    console.error("Erro ao carregar imagem:", promotion.imageUrl);
                };
            }

            slide.innerHTML = `
                <div class="promotion-card">
                    <h2>${promotion.productName || 'Produto não especificado'}</h2>
                    <p><strong>de R$:</strong> <originalPrice> ${(promotion.originalPrice || 0).toFixed(2).replace('.', ',')} </originalPrice></p>
                    <p><strong>por R$:</strong> <promotionalPrice> ${(promotion.promotionalPrice || 0).toFixed(2).replace('.', ',')} </promotionalPrice> </p>
                    <p><strong>Promoção válida até:</strong> ${promotion.expirationDate ? new Date(promotion.expirationDate).toLocaleDateString('pt-BR') : 'N/A'}</p>
                </div>
            `;

            slider.appendChild(slide);

            // Se for a primeira promoção, inicia o slideshow
            if (document.querySelectorAll('.slide').length === 1) {
                startSlideShow();
                slide.classList.add('active');
                currentSlide = 0;
            }
        }
    }

    function startSlideShow() {
        if (!slideIntervalId) {
            slideIntervalId = setInterval(updateSlideShow, slideInterval);
        }
    }

    function stopSlideShow() {
        if (slideIntervalId) {
            clearInterval(slideIntervalId);
            slideIntervalId = null;
        }
    }

    function updateSlideShow() {
        const slides = document.querySelectorAll('.slide');
        
        // Se não houver slides, mostra mensagem de boas-vindas
        if (slides.length === 0) {
            welcomeMessage.style.display = 'flex';
            stopSlideShow();
            return;
        }

        // Remove classe 'active' de todos os slides
        slides.forEach(slide => slide.classList.remove('active'));
        
        // Avança para o próximo slide
        currentSlide = (currentSlide + 1) % slides.length;
        
        // Adiciona classe 'active' ao slide atual
        slides[currentSlide].classList.add('active');
    }

    // Função para limpar promoções expiradas
    function clearExpiredPromotions() {
        const now = new Date();
        const slides = document.querySelectorAll('.slide');
        let removedAny = false;
        
        slides.forEach(slide => {
            const expirationText = slide.querySelector('p:last-child').textContent;
            const expirationDateMatch = expirationText.match(/\d{2}\/\d{2}\/\d{4}/);
            
            if (expirationDateMatch) {
                const [day, month, year] = expirationDateMatch[0].split('/');
                const expirationDate = new Date(`${year}-${month}-${day}`);
                
                if (expirationDate < now) {
                    const promotionId = slide.dataset.promotionId;
                    activePromotionIds.delete(promotionId);
                    slide.remove();
                    removedAny = true;
                }
            }
        });
        
        // Se removeu algum slide, ajusta o índice atual
        if (removedAny) {
            const remainingSlides = document.querySelectorAll('.slide');
            if (remainingSlides.length === 0) {
                welcomeMessage.style.display = 'flex';
                stopSlideShow();
            } else if (currentSlide >= remainingSlides.length) {
                currentSlide = 0;
                if (remainingSlides.length > 0) {
                    remainingSlides[currentSlide].classList.add('active');
                }
            }
        }
    }

    // Funções de conexão
    function setStatus(status, message) {
        statusElement.textContent = message;
        statusElement.className = `status ${status}`;
    }

    async function loadExistingPromotions() {
        try {
            const response = await fetch('/api/promotions');
            if (!response.ok) throw new Error('Erro ao carregar promoções');
            const promotions = await response.json();
            
            // Limpa apenas promoções expiradas
            clearExpiredPromotions();
            
            // Adiciona novas promoções
            promotions.forEach(promotion => {
                showPromotionSlide(promotion);
            });
        } catch (error) {
            console.error('Erro ao carregar promoções:', error);
        }
    }

    function connect() {
        setStatus("connecting", "Conectando...");
        reconnectBtn.style.display = 'none';

        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }

        // Não reseta o slider automaticamente - mantém as promoções existentes
        welcomeMessage.style.display = document.querySelectorAll('.slide').length === 0 ? 'flex' : 'none';

        const socket = new SockJS(`http://${serverAddress}:${serverPort}/ws-promotions`);
        stompClient = Stomp.over(socket);

        stompClient.reconnect_delay = 5000;
        stompClient.heartbeatIncoming = 4000;
        stompClient.heartbeatOutgoing = 4000;
        stompClient.debug = () => {};

        stompClient.connect({}, function(frame) {
            setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
            reconnectBtn.style.display = 'none';
            loadExistingPromotions();

            stompClient.subscribe(promotionsTopic, function(message) {
                try {
                    const promotion = JSON.parse(message.body);
                    showPromotionSlide(promotion);
                } catch (e) {
                    console.error("Erro ao processar mensagem:", e);
                }
            });

        }, function(error) {
            console.error("Erro na conexão:", error);
            setStatus("disconnected", "Falha na conexão");
            reconnectBtn.style.display = 'block';
            setTimeout(connect, 5000);
        });
    }

    // Funções de fullscreen
    function toggleFullscreen() {
        if (!isFullscreen) {
            enterFullscreen();
        } else {
            exitFullscreen();
        }
    }

    function enterFullscreen() {
        const element = document.documentElement;
        if (element.requestFullscreen) {
            element.requestFullscreen()
                .then(() => {
                    isFullscreen = true;
                    hideControls();
                })
                .catch(err => {
                    console.error("Erro ao entrar em tela cheia:", err);
                    showFullscreenButton();
                });
        }
    }

    function exitFullscreen() {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
        isFullscreen = false;
        showControls();
    }

    function showFullscreenButton() {
        fullscreenBtn.style.display = 'block';
        fullscreenBtn.textContent = 'TELA CHEIA';
    }

    function hideFullscreenButton() {
        fullscreenBtn.style.display = 'none';
    }

    function hideControls() {
        statusElement.classList.add('controls-hidden');
        reconnectBtn.classList.add('controls-hidden');
        fullscreenBtn.classList.add('controls-hidden');
        document.getElementById('department-selector').classList.add('controls-hidden');
    }

    function showControls() {
        statusElement.classList.remove('controls-hidden');
        reconnectBtn.classList.remove('controls-hidden');
        fullscreenBtn.classList.remove('controls-hidden');
        document.getElementById('department-selector').classList.remove('controls-hidden');
    }

    function handleMouseMove() {
        if (isFullscreen) {
            showControls();
            resetHideTimeout();
        }
    }

    function resetHideTimeout() {
        clearTimeout(mouseTimeout);
        mouseTimeout = setTimeout(() => {
            if (isFullscreen) {
                hideControls();
            }
        }, hideDelay);
    }

    // Inicialização
    window.addEventListener('load', async function() {
        await loadDepartments();
        
        departmentSelect.addEventListener('change', function() {
            selectedDepartment = this.value;
            resetSlider();
            
            if (stompClient && stompClient.connected) {
                loadExistingPromotions();
            }
        });

        // Configura controles
        showFullscreenButton();
        setTimeout(() => {
            if (!document.fullscreenElement) {
                enterFullscreen();
            }
        }, 1000);

        // Inicia conexão
        connect();
        
        // Verifica promoções expiradas periodicamente
        setInterval(clearExpiredPromotions, 60000); // Verifica a cada minuto
    });

    // Event listeners
    window.addEventListener('beforeunload', function() {
        if (stompClient) stompClient.disconnect();
    });

    reconnectBtn.addEventListener('click', connect);
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    document.addEventListener('fullscreenchange', () => {
        isFullscreen = !!document.fullscreenElement;
        if (isFullscreen) {
            document.addEventListener('mousemove', handleMouseMove);
            resetHideTimeout();
        } else {
            document.removeEventListener('mousemove', handleMouseMove);
            clearTimeout(mouseTimeout);
            showControls();
        }
    });
</script>
</body>
</html>