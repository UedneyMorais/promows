<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PromoWS - Promoções em Slide</title>
    <style>
        html, body {
          margin: 0;
          padding: 0;
          overflow: hidden;
          height: 100%;
          font-family: Arial, sans-serif;
          background-color: #000;
          color: #fff;
        }

        .status {
          position: absolute;
          top: 10px;
          left: 10px;
          padding: 10px;
          border-radius: 5px;
          z-index: 1000;
          background-color: rgba(0,0,0,0.7);
          transition: opacity 0.5s ease;
        }

        .connected { color: #28a745; }
        .disconnected { color: #dc3545; }
        .connecting { color: #ffc107; }

        #reconnect-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            z-index: 1000;
            display: none; /* Inicialmente escondido */
            transition: opacity 0.5s ease;
        }

        #department-selector {
          position: absolute;
          top: 60px;
          left: 10px;
          padding: 10px;
          z-index: 1000;
          background-color: rgba(0,0,0,0.7);
          border-radius: 5px;
        }

        #department-selector select {
          padding: 8px;
          font-size: 16px;
          border-radius: 5px;
          background-color: #333;
          color: white;
          border: 1px solid #555;
        }

        #slider {
          width: 100%;
          height: 100%;
          position: relative;
        }

        .slide {
          position: absolute;
          width: 100%;
          height: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
          transition: opacity 1s ease-in-out;
          opacity: 0;
        }

        .slide.active {
          opacity: 1;
          z-index: 1;
        }

        .promotion-card {
          width: 100%;
          height: 100%;
          box-sizing: border-box;
          padding: 5vh 5vw;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          background-color: rgba(0, 0, 0, 0.6);
          text-align: center;
        }

        .promotion-card h2 {
          font-size: 16vh;
          margin: 1vh 0;
          color: #fca311;
        }

        .promotion-card originalPrice {
           font-size: 14vh;
           margin: 1vh 0;
           color: #fff;
           text-decoration: line-through;
           text-decoration-thickness: 0.5vh;
           opacity: 0.8;
        }

        .promotion-card promotionalPrice {
          font-size: 28.8vh;
          margin: 1vh 0;
          font-weight: bold;
          color: #fca311;
          text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .promotion-card .department {
          font-size: 6vh;
          color: #e63946;
          margin-bottom: 2vh;
        }

        .promotion-card p {
          font-size: 5vh;
          margin: 1vh 0;
        }

        #fullscreen-btn {
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 15px 25px;
          background-color: rgba(255, 165, 0, 0.8);
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          z-index: 10000;
          font-size: 16px;
          font-weight: bold;
          transition: opacity 0.5s ease;
        }

        #fullscreen-btn:hover {
          background-color: rgba(255, 165, 0, 1);
        }

        .controls-hidden {
          opacity: 0 !important;
          pointer-events: none !important;
        }

        #welcome-message {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
          background-color: rgba(0, 0, 0, 0.7);
          z-index: 10;
          font-size: 10vh;
          color: #fca311;
          text-align: center;
          padding: 20px;
        }
    </style>
</head>
<body>

<div id="status" class="status disconnected">Desconectado</div>
<button id="reconnect-btn">Reconectar</button>
<div id="department-selector">
    <select id="department-select">
        <option value="AÇOUGUE">Açougue</option>
        <option value="PADARIA">Padaria</option>
        <option value="HORTIFRUTI">Hortifruti</option>
        <option value="LATICINIOS">Laticínios</option>
        <option value="BEBIDAS">Bebidas</option>
        <option value="LIMPEZA">Limpeza</option>
    </select>
</div>
<button id="fullscreen-btn">TELA CHEIA</button>

<div id="welcome-message">Seja bem-vindo!<br>Fique atento às nossas promoções</div>

<div id="slider"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<!-- Adicione isto ANTES do stomp.js -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>

<script>
    // Lê configurações do servidor
    let serverAddress = null;
    let serverPort = null;
    let socketEndpoint = null;
    loadConfig();

    const promotionsTopic = "/topic/promotions";
    const defaultImage = "https://cdn.pixabay.com/photo/2018/08/30/14/46/food-3642376_1280.jpg";

    // Elementos da DOM
    const statusElement = document.getElementById('status');
    const slider = document.getElementById('slider');
    const reconnectBtn = document.getElementById('reconnect-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const welcomeMessage = document.getElementById('welcome-message');
    const departmentSelect = document.getElementById('department-select');

    // Variáveis globais
    let stompClient = null;
    let currentSlide = 0;
    const slideInterval = 8000;
    let mouseTimeout;
    const hideDelay = 3000;
    let isFullscreen = false;
    let selectedDepartment = departmentSelect.value;
    let activePromotionIds = new Set();
    let slideIntervalId = null;

    // 1. FUNÇÕES DE FULLSCREEN ==============================================
    function toggleFullscreen() {
      if (!isFullscreen) {
        enterFullscreen();
      } else {
        exitFullscreen();
      }
    }

    function enterFullscreen() {
      const element = document.documentElement;

      if (element.requestFullscreen) {
        element.requestFullscreen().then(() => {
          isFullscreen = true;
          hideControls();
        }).catch(err => {
          console.error("Erro ao entrar em tela cheia:", err);
          showFullscreenButton();
        });
      } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
      } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen();
      } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
      }
    }

    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      isFullscreen = false;
      showControls();
    }

    function showFullscreenButton() {
      fullscreenBtn.style.display = 'block';
      fullscreenBtn.textContent = 'TELA CHEIA';
    }

    function hideFullscreenButton() {
      fullscreenBtn.style.display = 'none';
    }

    function hideControls() {
      statusElement.classList.add('controls-hidden');
      reconnectBtn.classList.add('controls-hidden');
      fullscreenBtn.classList.add('controls-hidden');
      document.getElementById('department-selector').classList.add('controls-hidden');
    }

    function showControls() {
      statusElement.classList.remove('controls-hidden');
      reconnectBtn.classList.remove('controls-hidden');
      fullscreenBtn.classList.remove('controls-hidden');
      document.getElementById('department-selector').classList.remove('controls-hidden');
    }

    function handleMouseMove() {
      if (isFullscreen) {
        showControls();
        resetHideTimeout();
      }
    }

    function resetHideTimeout() {
      clearTimeout(mouseTimeout);
      mouseTimeout = setTimeout(() => {
        if (isFullscreen) {
          hideControls();
        }
      }, hideDelay);
    }

    // Event listeners para fullscreen
    fullscreenBtn.addEventListener('click', toggleFullscreen);

    document.addEventListener('fullscreenchange', () => {
      isFullscreen = !!document.fullscreenElement;
      if (isFullscreen) {
        document.addEventListener('mousemove', handleMouseMove);
        resetHideTimeout();
      } else {
        document.removeEventListener('mousemove', handleMouseMove);
        clearTimeout(mouseTimeout);
        showControls();
      }
    });

    // 2. FUNÇÕES DO SLIDE ==================================================
    function showPromotionSlide(promotion) {
      // Verifica se a promoção é do departamento selecionado e se não está ativa
      if (promotion.departament.toUpperCase() === selectedDepartment &&
          !activePromotionIds.has(promotion.id)) {

        activePromotionIds.add(promotion.id);
        welcomeMessage.style.display = 'none';

        const slide = document.createElement('div');
        slide.className = 'slide promotion-slide';
        slide.dataset.promotionId = promotion.id;

        // Usa a imagem padrão inicialmente
        slide.style.backgroundImage = `url('${defaultImage}')`;

        // Tenta carregar a imagem da promoção em segundo plano
        if (promotion.imageUrl) {
          const img = new Image();
          img.src = promotion.imageUrl;
          img.onload = function() {
            slide.style.backgroundImage = `url('${promotion.imageUrl}')`;
          };
          img.onerror = function() {
            console.error("Erro ao carregar imagem:", promotion.imageUrl);
          };
        }

        slide.innerHTML = `
          <div class="promotion-card">
            <h2>${promotion.productName || 'Produto não especificado'}</h2>
            <p><strong>de R$:</strong> <originalPrice>${(promotion.originalPrice || 0).toFixed(2)} </originalPrice></p>
            <p><strong>por R$:</strong> <promotionalPrice>${(promotion.promotionalPrice || 0).toFixed(2)} </promotionalPrice></p>
            <p><strong>Promoção válida até:</strong> ${promotion.expirationDate ? new Date(promotion.expirationDate).toLocaleDateString('pt-BR') : 'N/A'}</p>
          </div>
        `;

        slider.appendChild(slide);

        // Se for o primeiro slide, inicie o slideshow
        if (document.querySelectorAll('.slide').length === 1) {
          startSlideShow();
          slide.classList.add('active');
          currentSlide = 0;
        }
      }
    }

    function startSlideShow() {
      if (!slideIntervalId) {
        slideIntervalId = setInterval(updateSlideShow, slideInterval);
      }
    }

    function stopSlideShow() {
      if (slideIntervalId) {
        clearInterval(slideIntervalId);
        slideIntervalId = null;
      }
    }

    function updateSlideShow() {
      const slides = document.querySelectorAll('.slide');

      if (slides.length === 0) {
        welcomeMessage.style.display = 'flex';
        activePromotionIds.clear();
        stopSlideShow();
        return;
      }

      welcomeMessage.style.display = 'none';

      // Atualiza o conjunto de IDs ativos
      const currentIds = new Set();
      slides.forEach(slide => {
        currentIds.add(slide.dataset.promotionId);
      });

      // Remove IDs que não estão mais nos slides
      activePromotionIds.forEach(id => {
        if (!currentIds.has(id)) {
          activePromotionIds.delete(id);
        }
      });

      slides.forEach((slide, index) => {
        slide.classList.remove('active');
        if (index === currentSlide) {
          slide.classList.add('active');
        }
      });

      currentSlide = (currentSlide + 1) % slides.length;
    }

        // 3. FUNÇÕES DE CONEXÃO WEBSOCKET =====================================
    function setStatus(status, message) {
      statusElement.textContent = message;
      statusElement.className = `status ${status}`;
      console.log(`Status: ${status} - ${message}`);
    }

    function loadConfig() {
        fetch('/api/config')
            .then(response => response.json())
            .then(config => {
                serverAddress = config.serverAddress;
                serverPort = config.serverPort;
                socketEndpoint = `ws://${serverAddress}:${serverPort}/ws-promotions`;
            })
            .catch(error => {
                console.error("Erro ao carregar configurações:", error);
                serverAddress = window.location.hostname;
                serverPort = window.location.port || '9090';
                socketEndpoint = `ws://${serverAddress}:${serverPort}/ws-promotions`;
            });
    }

    function loadExistingPromotions() {
        return fetch('/api/promotions')
            .then(response => {
                if (!response.ok) throw new Error('Erro ao carregar promoções');
                return response.json();
            })
            .then(promotions => {
                promotions.forEach(promotion => {
                    showPromotionSlide(promotion);
                });
            })
            .catch(error => {
                console.error('Erro ao carregar promoções existentes:', error);
            });
    }

    function connect() {
        setStatus("connecting", "Conectando...");
        reconnectBtn.style.display = 'none';

        // Desconecta se já estiver conectado
        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }

        // Limpa o slider
        slider.innerHTML = '';
        activePromotionIds.clear();
        welcomeMessage.style.display = 'flex';

        // Cria nova conexão
        const socket = new SockJS(socketEndpoint);
        stompClient = Stomp.over(socket);

        stompClient.reconnect_delay = 5000;
        stompClient.heartbeatIncoming = 4000;
        stompClient.heartbeatOutgoing = 4000;

        // Desativa logs de debug (opcional)
        stompClient.debug = () => {};

        stompClient.connect({}, function(frame) {
            // Conexão bem sucedida
            setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
            reconnectBtn.style.display = 'none';

            // Carrega promoções existentes
            loadExistingPromotions().then(() => {
                console.log('Promoções carregadas com sucesso');
            });

            // Assina o tópico de promoções
            stompClient.subscribe(promotionsTopic, function(message) {
                try {
                    const promotion = JSON.parse(message.body);
                    showPromotionSlide(promotion);
                } catch (e) {
                    console.error("Erro ao processar mensagem:", e);
                }
            });

        }, function(error) {
            console.error("Erro na conexão:", error);
            setStatus("disconnected", "Falha na conexão");
            reconnectBtn.style.display = 'block';

            // Tentar reconectar após 5 segundos
            setTimeout(connect, 5000);
        });
    }

    // 4. INICIALIZAÇÃO =====================================================
    window.addEventListener('load', function() {
        // Configurar listener para mudança de departamento
        departmentSelect.addEventListener('change', function() {
            selectedDepartment = this.value;
            slider.innerHTML = '';
            activePromotionIds.clear();
            welcomeMessage.style.display = 'flex';



            // Atualiza o status durante a mudança
            if (stompClient && stompClient.connected) {
                setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
            } else {
                setStatus("connecting", "Conectando...");
            }

            loadExistingPromotions().then(() => {
                setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
                });
            });

            //setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);


<!--        // Carrega configurações e inicia conexão-->
<!--        //loadConfig();-->
<!--        //connect();-->


        // Mostrar botão de fullscreen inicialmente
        showFullscreenButton();

        // Tentar entrar em fullscreen após pequeno delay
        setTimeout(() => {
            if (!document.fullscreenElement) {
                enterFullscreen();
            }
        }, 1000);
    });

    window.addEventListener('beforeunload', function() {
        if (stompClient) {
            stompClient.disconnect();
        }
    });

    reconnectBtn.addEventListener('click', function() {
        connect();
    });
</script>
</body>
</html>
