<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PromoWS - Promoções em Slide</title>
    <link rel="stylesheet" href="./css/styles-promotions.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=Poppins&display=swap" rel="stylesheet">
</head>
<body>

<div id="status" class="status disconnected">Desconectado</div>
<button id="reconnect-btn">Reconectar</button>
<div id="department-selector">
    <div id="department-loading">Carregando departamentos...</div>
    <select id="department-select" style="display: none;"></select>
</div>
<button id="fullscreen-btn">TELA CHEIA</button>

<div id="welcome-message">Seja bem-vindo!<br>Fique atento às nossas promoções</div>

<div id="slider"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>

<script>
    // Configurações
    const serverAddress = window.location.hostname;
    const serverPort = window.location.port || '9090';
    let socketEndpoint = `ws://${serverAddress}:${serverPort}/ws-promotions`;
    const promotionsTopic = "/topic/promotions";
    const defaultImage = "https://cdn.pixabay.com/photo/2018/08/30/14/46/food-3642376_1280.jpg";

    // Elementos DOM
    const statusElement = document.getElementById('status');
    const slider = document.getElementById('slider');
    const reconnectBtn = document.getElementById('reconnect-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const welcomeMessage = document.getElementById('welcome-message');
    const departmentSelect = document.getElementById('department-select');
    const departmentLoading = document.getElementById('department-loading');

    // Variáveis globais
    let stompClient = null;
    let currentSlide = 0;
    const slideInterval = 8000;
    let mouseTimeout;
    const hideDelay = 3000;
    let isFullscreen = false;
    let selectedDepartment = null;
    let activePromotionIds = new Set();
    let slideIntervalId = null;

    // Funções auxiliares
    function formatDepartmentName(name) {
        return name
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-zA-Z\s]/g, '')
            .toUpperCase();
    }

    function resetSlider() {
        slider.innerHTML = '';
        activePromotionIds.clear();
        welcomeMessage.style.display = 'flex';
    }

    // Funções de departamento
    async function loadDepartments() {
        try {
            const response = await fetch('/api/departaments');
            if (!response.ok) throw new Error('Erro na API');
            const departments = await response.json();

            departmentSelect.innerHTML = '';
            
            departments.forEach(dept => {
                const formattedValue = formatDepartmentName(dept.departamentName);
                const option = new Option(dept.departamentName, formattedValue);
                departmentSelect.add(option);
            });

            departmentLoading.style.display = 'none';
            departmentSelect.style.display = 'block';
            selectedDepartment = departmentSelect.value;

        } catch (error) {
            console.error('Erro ao carregar departamentos:', error);
            departmentSelect.innerHTML = `
                <option value="PADARIA">Padaria</option>
                <option value="ACOUGUE">Açougue</option>
                <option value="HORTIFRUTI">Hortifruti</option>
            `;
            departmentLoading.style.display = 'none';
            departmentSelect.style.display = 'block';
            selectedDepartment = "PADARIA";
        }
    }

    // Funções de slide
    function showPromotionSlide(promotion) {
        const promoDeptFormatted = formatDepartmentName(promotion.departament.departamentName);
        
        if (promoDeptFormatted === selectedDepartment && !activePromotionIds.has(promotion.id)) {
            activePromotionIds.add(promotion.id);
            welcomeMessage.style.display = 'none';

            const slide = document.createElement('div');
            slide.className = 'slide promotion-slide';
            slide.dataset.promotionId = promotion.id;
            slide.style.backgroundImage = `url('${defaultImage}')`;

            if (promotion.imageUrl) {
                const img = new Image();
                img.src = promotion.imageUrl;
                img.onload = function() {
                    slide.style.backgroundImage = `url('${promotion.imageUrl}')`;
                };
                img.onerror = function() {
                    console.error("Erro ao carregar imagem:", promotion.imageUrl);
                };
            }

            slide.innerHTML = `
                <div class="promotion-card">
                    <h2>${promotion.productName || 'Produto não especificado'}</h2>
                    <p><strong>de R$:</strong> <originalPrice> ${(promotion.originalPrice || 0).toFixed(2).replaceAll('.', ',')} </originalPrice></p>
                    <p><strong>por R$:</strong> <promotionalPrice> ${(promotion.promotionalPrice || 0).toFixed(2).replaceAll('.', ',')} </promotionalPrice> </p>
                    <p><strong>Promoção válida até:</strong> ${promotion.expirationDate ? new Date(promotion.expirationDate).toLocaleDateString('pt-BR') : 'N/A'}</p>
                </div>
            `;

            slider.appendChild(slide);

            if (document.querySelectorAll('.slide').length === 1) {
                startSlideShow();
                slide.classList.add('active');
                currentSlide = 0;
            }
        }
    }

    function startSlideShow() {
        if (!slideIntervalId) {
            slideIntervalId = setInterval(updateSlideShow, slideInterval);
        }
    }

    function stopSlideShow() {
        if (slideIntervalId) {
            clearInterval(slideIntervalId);
            slideIntervalId = null;
        }
    }

    function updateSlideShow() {
        const slides = document.querySelectorAll('.slide');
        if (slides.length === 0) {
            welcomeMessage.style.display = 'flex';
            activePromotionIds.clear();
            stopSlideShow();
            return;
        }

        welcomeMessage.style.display = 'none';
        const currentIds = new Set();
        slides.forEach(slide => currentIds.add(slide.dataset.promotionId));

        activePromotionIds.forEach(id => {
            if (!currentIds.has(id)) activePromotionIds.delete(id);
        });

        slides.forEach((slide, index) => {
            slide.classList.remove('active');
            if (index === currentSlide) slide.classList.add('active');
        });

        currentSlide = (currentSlide + 1) % slides.length;
    }

    // Funções de conexão
    function setStatus(status, message) {
        statusElement.textContent = message;
        statusElement.className = `status ${status}`;
    }

    async function loadExistingPromotions() {
        try {
            const response = await fetch('/api/promotions');
            if (!response.ok) throw new Error('Erro ao carregar promoções');
            const promotions = await response.json();
            promotions.forEach(promotion => showPromotionSlide(promotion));
        } catch (error) {
            console.error('Erro ao carregar promoções:', error);
        }
    }

    function connect() {
        setStatus("connecting", "Conectando...");
        reconnectBtn.style.display = 'none';

        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }

        // Modificação importante: só reseta se realmente não houver promoções
        if (!hasExistingPromotions()) {
            resetSlider();
        } else {
        // Se houver promoções, garante que a mensagem de boas-vindas fica oculta
            welcomeMessage.style.display = 'none';
        }

        const socket = new SockJS(`http://${serverAddress}:${serverPort}/ws-promotions`);
        stompClient = Stomp.over(socket);

        stompClient.reconnect_delay = 5000;
        // stompClient.heartbeatIncoming = 4000;
        // stompClient.heartbeatOutgoing = 4000;
        stompClient.debug = () => {};

        stompClient.connect({}, function(frame) {
            setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
            reconnectBtn.style.display = 'none';
            loadExistingPromotions();

            stompClient.subscribe(promotionsTopic, function(message) {
                try {
                    const promotion = JSON.parse(message.body);
                    showPromotionSlide(promotion);
                } catch (e) {
                    console.error("Erro ao processar mensagem:", e);
                }
            });

        }, function(error) {
            console.error("Erro na conexão:", error);
            setStatus("disconnected", "Falha na conexão");
            reconnectBtn.style.display = 'block';
            setTimeout(connect, 5000);
        });
    }

    function hasExistingPromotions() {
    const hasSlides = slider.querySelector('.slide') !== null;
    const hasActivePromotions = activePromotionIds.size > 0;
    
    return hasSlides || hasActivePromotions;
    }


    // Funções de fullscreen
    function toggleFullscreen() {
        if (!isFullscreen) {
            enterFullscreen();
        } else {
            exitFullscreen();
        }
    }

    function enterFullscreen() {
        const element = document.documentElement;
        if (element.requestFullscreen) {
            element.requestFullscreen()
                .then(() => {
                    isFullscreen = true;
                    hideControls();
                })
                .catch(err => {
                    console.error("Erro ao entrar em tela cheia:", err);
                    showFullscreenButton();
                });
        }
    }

    function exitFullscreen() {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
        isFullscreen = false;
        showControls();
    }

    function showFullscreenButton() {
        fullscreenBtn.style.display = 'block';
        fullscreenBtn.textContent = 'TELA CHEIA';
    }

    function hideFullscreenButton() {
        fullscreenBtn.style.display = 'none';
    }

    function hideControls() {
        statusElement.classList.add('controls-hidden');
        reconnectBtn.classList.add('controls-hidden');
        fullscreenBtn.classList.add('controls-hidden');
        document.getElementById('department-selector').classList.add('controls-hidden');
    }

    function showControls() {
        statusElement.classList.remove('controls-hidden');
        reconnectBtn.classList.remove('controls-hidden');
        fullscreenBtn.classList.remove('controls-hidden');
        document.getElementById('department-selector').classList.remove('controls-hidden');
    }

    function handleMouseMove() {
        if (isFullscreen) {
            showControls();
            resetHideTimeout();
        }
    }

    function resetHideTimeout() {
        clearTimeout(mouseTimeout);
        mouseTimeout = setTimeout(() => {
            if (isFullscreen) {
                hideControls();
            }
        }, hideDelay);
    }

    // Inicialização
    window.addEventListener('load', async function() {
        // Carrega departamentos
        await loadDepartments();
        
        // Configura listener de departamento
        departmentSelect.addEventListener('change', function() {
            selectedDepartment = this.value;
            resetSlider();
            
            if (stompClient && stompClient.connected) {
                loadExistingPromotions();
            }
        });

        // Configura controles
        showFullscreenButton();
        setTimeout(() => {
            if (!document.fullscreenElement) {
                enterFullscreen();
            }
        }, 1000);

        // Inicia conexão
        connect();
    });

    // Event listeners
    window.addEventListener('beforeunload', function() {
        if (stompClient) stompClient.disconnect();
    });

    reconnectBtn.addEventListener('click', connect);
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    document.addEventListener('fullscreenchange', () => {
        isFullscreen = !!document.fullscreenElement;
        if (isFullscreen) {
            document.addEventListener('mousemove', handleMouseMove);
            resetHideTimeout();
        } else {
            document.removeEventListener('mousemove', handleMouseMove);
            clearTimeout(mouseTimeout);
            showControls();
        }
    });
</script>
</body>
</html>