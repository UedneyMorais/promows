<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PromoWS - Promoções em Slide</title>
    <link rel="stylesheet" href="./css/promotions/styles-promotions.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=Poppins&display=swap" rel="stylesheet">
    <style>
        /* Estilos para o status da conexão */
        .status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
        }
        
        .connected {
            background-color: #4CAF50;
            color: white;
        }
        
        .disconnected {
            background-color: #f44336;
            color: white;
        }
        
        .connecting {
            background-color: #FFC107;
            color: black;
        }
        
        /* Efeito de fade para os controles */
        .controls-hidden {
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        /* Estilo do botão de tela cheia */
        #fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
        
        /* Seletor de departamentos */
        #department-selector {
            position: fixed;
            top: 50px;
            left: 10px;
            z-index: 1000;
        }

        /* Botão do menu */
        #goto-menu {
            position: fixed;
            top: 10px;
            left: 200px;
            z-index: 1000;
            padding: 8px 15px;
            background-color: rgb(48, 47, 47);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        
        /* Botão de reconexão */
        #reconnect-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            background-color: #9E9E9E;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>

<!-- Elementos da interface -->
<div id="status" class="status disconnected">Desconectado</div>
<button id="reconnect-btn">Reconectar</button>

<div id="department-selector">
    <div id="department-loading">Carregando departamentos...</div>
    <select id="department-select" style="display: none;"></select>
</div>
<button id="goto-menu">Menu</button>
<button id="fullscreen-btn">TELA CHEIA</button>

<!-- Mensagem de boas-vindas quando não há promoções -->
<div id="welcome-message">Seja bem-vindo!<br>Fique atento às nossas promoções</div>

<!-- Container principal do slider -->
<div id="slider"></div>

<!-- Bibliotecas externas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>

<script>
    // ============= CONFIGURAÇÕES GLOBAIS =============
    const serverAddress = window.location.hostname;
    const serverPort = window.location.port || '9090';
    let socketEndpoint = `ws://${serverAddress}:${serverPort}/ws-promotions`;
    const promotionsTopic = "/topic/promotions";
    const deletedPromotionsTopic = "/topic/deleted-promotions";
    const defaultImage = "https://cdn.pixabay.com/photo/2018/08/30/14/46/food-3642376_1280.jpg";

    // ============= ELEMENTOS DOM =============
    const statusElement = document.getElementById('status');
    const menuBtn = document.getElementById('goto-menu');
    const slider = document.getElementById('slider');
    const reconnectBtn = document.getElementById('reconnect-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const welcomeMessage = document.getElementById('welcome-message');
    const departmentSelect = document.getElementById('department-select');
    const departmentLoading = document.getElementById('department-loading');

    // ============= VARIÁVEIS GLOBAIS =============
    let stompClient = null;
    let currentSlide = 0;
    const slideInterval = 8000; // Intervalo entre slides (8 segundos)
    let mouseTimeout;
    const hideDelay = 3000; // Tempo para esconder controles em tela cheia
    let isFullscreen = false;
    let selectedDepartment = null;
    let activePromotionIds = new Set(); // Armazena IDs de promoções ativas
    let slideIntervalId = null;

    // ============= FUNÇÕES AUXILIARES =============

    /** Formata nomes de departamento para comparação */
    function formatDepartmentName(name) {
        return name
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
            .replace(/[^a-zA-Z\s]/g, '') // Remove caracteres especiais
            .toUpperCase(); // Padroniza para maiúsculas
    }

    /** Verifica se uma promoção é válida (ativa e dentro do prazo) */
    function isPromotionValid(promotion) {
        // Verifica status ativo
        if (!promotion.active) {
            return false;
        }
        
        // Se não tem data de expiração, considera válida
        if (!promotion.expirationDate) {
            return true;
        }
        
        // Compara datas
        const now = new Date();
        const expirationDate = new Date(promotion.expirationDate);
        return now <= expirationDate;
    }

    /** Reseta o slider para o estado inicial */
    function resetSlider() {
        const slides = document.querySelectorAll('.slide');
        slides.forEach(slide => slide.remove());
        activePromotionIds.clear();
        welcomeMessage.style.display = 'flex';
        currentSlide = 0;
        stopSlideShow();
    }

    /** Carrega a lista de departamentos da API */
    async function loadDepartments() {
        try {
            const response = await fetch('/api/departments');
            if (!response.ok) throw new Error('Erro na API');
            const departments = await response.json();

            departmentSelect.innerHTML = '';
            
            // Opção padrão para todos os departamentos
            const allOption = new Option('Todos os Departamentos', 'ALL');
            departmentSelect.add(allOption);
            
            // Adiciona cada departamento como opção
            departments.forEach(dept => {
                const formattedValue = formatDepartmentName(dept.departmentName);
                const option = new Option(dept.departmentName, formattedValue);
                departmentSelect.add(option);
            });

            departmentLoading.style.display = 'none';
            departmentSelect.style.display = 'block';
            selectedDepartment = departmentSelect.value;

        } catch (error) {
            console.error('Erro ao carregar departamentos:', error);
            // Fallback caso a API falhe
            departmentSelect.innerHTML = `
                <option value="ALL">Todos os Departamentos</option>
                <option value="PADARIA">Padaria</option>
                <option value="ACOUGUE">Açougue</option>
                <option value="HORTIFRUTI">Hortifruti</option>
            `;
            departmentLoading.style.display = 'none';
            departmentSelect.style.display = 'block';
            selectedDepartment = "ALL";
        }
    }

    /** Remove um slide de promoção pelo ID */
    function removePromotionSlide(promotionId) {
        const slideToRemove = document.querySelector(`.slide[data-promotion-id="${promotionId}"]`);
        
        if (slideToRemove) {
            const isActive = slideToRemove.classList.contains('active');
            slideToRemove.remove();
            activePromotionIds.delete(promotionId);
            
            const slides = document.querySelectorAll('.slide');
            
            if (slides.length === 0) {
                welcomeMessage.style.display = 'flex';
                stopSlideShow();
            } else if (isActive) {
                currentSlide = Math.max(0, currentSlide - 1);
                if (slides.length > 0) {
                    slides[currentSlide % slides.length].classList.add('active');
                }
            }
        }
    }

    // ============= FUNÇÕES DO SLIDER =============

    /** Exibe um novo slide de promoção */
    function showPromotionSlide(promotion) {
        // Verifica se a promoção é válida antes de exibir
        if (!isPromotionValid(promotion)) {
            return;
        }

        const promoDeptFormatted = formatDepartmentName(promotion.department.departmentName);
        const existingSlide = document.querySelector(`.slide[data-promotion-id="${promotion.id}"]`);
        const departmentMatch = (selectedDepartment === 'ALL') || (promoDeptFormatted === selectedDepartment);
        
        if (departmentMatch && !existingSlide) {
            activePromotionIds.add(promotion.id);
            welcomeMessage.style.display = 'none';

            // Cria o elemento do slide
            const slide = document.createElement('div');
            slide.className = 'slide promotion-slide';
            slide.dataset.promotionId = promotion.id;
            slide.style.backgroundImage = `url('${defaultImage}')`;

            // Carrega a imagem da promoção (se existir)
            if (promotion.imageUrl) {
                const img = new Image();
                img.src = promotion.imageUrl;
                img.onload = function() {
                    slide.style.backgroundImage = `url('${promotion.imageUrl}')`;
                };
                img.onerror = function() {
                    console.error("Erro ao carregar imagem:", promotion.imageUrl);
                };
            }

            // Estrutura HTML do slide
            slide.innerHTML = `
                <div class="promotion-card">
                    <h2>${promotion.productName || 'Produto não especificado'}</h2>
                    <p><strong>de R$:</strong> <originalPrice> ${(promotion.originalPrice || 0).toFixed(2).replace('.', ',')} </originalPrice></p>
                    <p><strong>por R$:</strong> <promotionalPrice> ${(promotion.promotionalPrice || 0).toFixed(2).replace('.', ',')} </promotionalPrice> </p>
                    <p><strong>Promoção válida até:</strong> ${promotion.expirationDate ? new Date(promotion.expirationDate).toLocaleDateString('pt-BR') : 'N/A'}</p>
                </div>
            `;

            slider.appendChild(slide);

            // Inicia o slideshow se for a primeira promoção
            if (document.querySelectorAll('.slide').length === 1) {
                startSlideShow();
                slide.classList.add('active');
                currentSlide = 0;
            }
        }
    }

    /** Atualiza um slide existente */
    function updateExistingSlide(slideElement, promotion) {
        // Verifica se a promoção ainda é válida
        if (!isPromotionValid(promotion)) {
            removePromotionSlide(promotion.id);
            return;
        }

        // Atualiza a imagem
        if (promotion.imageUrl && slideElement.style.backgroundImage !== `url('${promotion.imageUrl}')`) {
            const img = new Image();
            img.src = promotion.imageUrl;
            img.onload = function() {
                slideElement.style.backgroundImage = `url('${promotion.imageUrl}')`;
            };
            img.onerror = function() {
                console.error("Erro ao carregar imagem:", promotion.imageUrl);
                slideElement.style.backgroundImage = `url('${defaultImage}')`;
            };
        } else if (!promotion.imageUrl) {
            slideElement.style.backgroundImage = `url('${defaultImage}')`;
        }

        // Atualiza o conteúdo
        slideElement.innerHTML = `
            <div class="promotion-card">
                <h2>${promotion.productName || 'Produto não especificado'}</h2>
                <p><strong>de R$:</strong> <originalPrice> ${(promotion.originalPrice || 0).toFixed(2).replace('.', ',')} </originalPrice></p>
                <p><strong>por R$:</strong> <promotionalPrice> ${(promotion.promotionalPrice || 0).toFixed(2).replace('.', ',')} </promotionalPrice> </p>
                <p><strong>Promoção válida até:</strong> ${promotion.expirationDate ? new Date(promotion.expirationDate).toLocaleDateString('pt-BR') : 'N/A'}</p>
            </div>
        `;
        
        // Força atualização visual se o slide estiver ativo
        if (slideElement.classList.contains('active')) {
            slideElement.classList.remove('active');
            setTimeout(() => slideElement.classList.add('active'), 10);
        }
    }

    /** Inicia o slideshow automático */
    function startSlideShow() {
        if (!slideIntervalId) {
            slideIntervalId = setInterval(updateSlideShow, slideInterval);
        }
    }

    /** Para o slideshow automático */
    function stopSlideShow() {
        if (slideIntervalId) {
            clearInterval(slideIntervalId);
            slideIntervalId = null;
        }
    }

    /** Avança para o próximo slide */
    function updateSlideShow() {
        const slides = document.querySelectorAll('.slide');
        
        if (slides.length === 0) {
            welcomeMessage.style.display = 'flex';
            stopSlideShow();
            return;
        }

        slides.forEach(slide => slide.classList.remove('active'));
        currentSlide = (currentSlide + 1) % slides.length;
        slides[currentSlide].classList.add('active');
    }

    /** Remove promoções expiradas */
    function clearExpiredPromotions() {
        const now = new Date();
        const slides = document.querySelectorAll('.slide');
        let removedAny = false;
        
        slides.forEach(slide => {
            const expirationText = slide.querySelector('p:last-child').textContent;
            const expirationDateMatch = expirationText.match(/\d{2}\/\d{2}\/\d{4}/);
            
            if (expirationDateMatch) {
                const [day, month, year] = expirationDateMatch[0].split('/');
                const expirationDate = new Date(`${year}-${month}-${day}`);
                
                if (expirationDate < now) {
                    const promotionId = slide.dataset.promotionId;
                    activePromotionIds.delete(promotionId);
                    slide.remove();
                    removedAny = true;
                }
            }
        });
        
        if (removedAny) {
            const remainingSlides = document.querySelectorAll('.slide');
            if (remainingSlides.length === 0) {
                welcomeMessage.style.display = 'flex';
                stopSlideShow();
            } else if (currentSlide >= remainingSlides.length) {
                currentSlide = 0;
                if (remainingSlides.length > 0) {
                    remainingSlides[currentSlide].classList.add('active');
                }
            }
        }
    }

    // ============= FUNÇÕES DE CONEXÃO =============

    /** Atualiza o status da conexão na interface */
    function setStatus(status, message) {
        statusElement.textContent = message;
        statusElement.className = `status ${status}`;
    }

    /** Carrega as promoções existentes da API */
    async function loadExistingPromotions() {
        try {
            const response = await fetch('/api/promotions');
            if (!response.ok) throw new Error('Erro ao carregar promoções');
            const promotions = await response.json();
            
            // Filtra apenas promoções válidas
            const validPromotions = promotions.filter(promotion => isPromotionValid(promotion));
            
            clearExpiredPromotions();
            
            validPromotions.forEach(promotion => {
                showPromotionSlide(promotion);
            });
        } catch (error) {
            console.error('Erro ao carregar promoções:', error);
        }
    }

    /** Estabelece conexão WebSocket com o servidor */
    function connect() {
        setStatus("connecting", "Conectando...");
        reconnectBtn.style.display = 'none';

        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }

        welcomeMessage.style.display = document.querySelectorAll('.slide').length === 0 ? 'flex' : 'none';

        const socket = new SockJS(`http://${serverAddress}:${serverPort}/ws-promotions`);
        stompClient = Stomp.over(socket);

        // Configurações de reconexão automática
        stompClient.reconnect_delay = 5000;
        stompClient.heartbeatIncoming = 4000;
        stompClient.heartbeatOutgoing = 4000;
        stompClient.debug = () => {};

        stompClient.connect({}, function(frame) {
            setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
            reconnectBtn.style.display = 'none';
            loadExistingPromotions();

            // Assina o tópico de novas/atualizações de promoções
            stompClient.subscribe(promotionsTopic, function(message) {
                try {
                    const promotion = JSON.parse(message.body);
                    
                    if (!isPromotionValid(promotion)) {
                        removePromotionSlide(promotion.id);
                        return;
                    }

                    const existingSlide = document.querySelector(`.slide[data-promotion-id="${promotion.id}"]`);
        
                    if (existingSlide) {
                        updateExistingSlide(existingSlide, promotion);
                    } else {
                        showPromotionSlide(promotion);
                    }
                } catch (e) {
                    console.error("Erro ao processar mensagem:", e);
                }
            });

            // Assina o tópico de promoções deletadas
            stompClient.subscribe(deletedPromotionsTopic, function(message) {
                try {
                    const deletedPromotion = JSON.parse(message.body);
                    removePromotionSlide(deletedPromotion.id);
                } catch (e) {
                    console.error("Erro ao processar mensagem de deleção:", e);
                }
            });

        }, function(error) {
            console.error("Erro na conexão:", error);
            setStatus("disconnected", "Falha na conexão");
            reconnectBtn.style.display = 'block';
            setTimeout(connect, 5000); // Tenta reconectar após 5 segundos
        });
    }

    // ============= FUNÇÕES DE TELA CHEIA =============

    /** Alterna entre tela cheia e normal */
    function toggleFullscreen() {
        if (!isFullscreen) {
            enterFullscreen();
        } else {
            exitFullscreen();
        }
    }

    /** Entra em modo tela cheia */
    function enterFullscreen() {
        const element = document.documentElement;
        if (element.requestFullscreen) {
            element.requestFullscreen()
                .then(() => {
                    isFullscreen = true;
                    hideControls();
                })
                .catch(err => {
                    console.error("Erro ao entrar em tela cheia:", err);
                    showFullscreenButton();
                });
        }
    }

    /** Sai do modo tela cheia */
    function exitFullscreen() {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
        isFullscreen = false;
        showControls();
    }

    /** Mostra o botão de tela cheia */
    function showFullscreenButton() {
        fullscreenBtn.style.display = 'block';
        fullscreenBtn.textContent = 'TELA CHEIA';
    }

    /** Esconde o botão de tela cheia */
    function hideFullscreenButton() {
        fullscreenBtn.style.display = 'none';
    }

    /** Esconde os controles na tela cheia */
    function hideControls() {
        statusElement.classList.add('controls-hidden');
        reconnectBtn.classList.add('controls-hidden');
        fullscreenBtn.classList.add('controls-hidden');
        menuBtn.classList.add('controls-hidden');
        document.getElementById('department-selector').classList.add('controls-hidden');
    }

    /** Mostra os controles na tela cheia */
    function showControls() {
        statusElement.classList.remove('controls-hidden');
        reconnectBtn.classList.remove('controls-hidden');
        menuBtn.classList.remove('controls-hidden');
        fullscreenBtn.classList.remove('controls-hidden');
        document.getElementById('department-selector').classList.remove('controls-hidden');
    }

    /** Manipula o movimento do mouse para mostrar/ocultar controles */
    function handleMouseMove() {
        if (isFullscreen) {
            showControls();
            resetHideTimeout();
        }
    }

    /** Reinicia o timeout para esconder controles */
    function resetHideTimeout() {
        clearTimeout(mouseTimeout);
        mouseTimeout = setTimeout(() => {
            if (isFullscreen) {
                hideControls();
            }
        }, hideDelay);
    }

    // ============= INICIALIZAÇÃO =============

    window.addEventListener('load', async function() {
        // Carrega departamentos
        await loadDepartments();
        
        // Configura o listener do seletor de departamentos
        departmentSelect.addEventListener('change', function() {
            selectedDepartment = this.value;
            resetSlider();
            
            if (stompClient && stompClient.connected) {
                loadExistingPromotions();
            }
        });

        // Configura controles de tela cheia
        showFullscreenButton();
        setTimeout(() => {
            if (!document.fullscreenElement) {
                enterFullscreen();
            }
        }, 1000);

        // Inicia a conexão WebSocket
        connect();
        
        // Verifica promoções expiradas periodicamente (1 minuto)
        setInterval(clearExpiredPromotions, 60000);
    });

    // ============= EVENT LISTENERS =============

    window.addEventListener('beforeunload', function() {
        if (stompClient) stompClient.disconnect();
    });

    /** Redireciona para o menu */
    function gotoMenu() {
        window.location.href = '/promotions/list-promotions.html';
    }

    // Associa funções aos botões
    reconnectBtn.addEventListener('click', connect);
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    menuBtn.addEventListener('click', gotoMenu);

    // Listener para mudanças no modo tela cheia
    document.addEventListener('fullscreenchange', () => {
        isFullscreen = !!document.fullscreenElement;
        if (isFullscreen) {
            document.addEventListener('mousemove', handleMouseMove);
            resetHideTimeout();
        } else {
            document.removeEventListener('mousemove', handleMouseMove);
            clearTimeout(mouseTimeout);
            showControls();
        }
    });
</script>
</body>
</html>