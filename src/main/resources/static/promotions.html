<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PromoWS - Promoções em Slide</title>
    <link rel="stylesheet" href="./css/promotions/styles-promotions.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=Poppins&display=swap" rel="stylesheet">
    <style>
        /* Estilos otimizados */
        .status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
        }
        
        .connected { background-color: #4CAF50; color: white; }
        .disconnected { background-color: #f44336; color: white; }
        .connecting { background-color: #FFC107; color: black; }
        
        #fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
        
        #department-selector {
            position: fixed;
            top: 50px;
            left: 10px;
            z-index: 1000;
        }

        #goto-menu, #reconnect-btn {
            position: fixed;
            top: 10px;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1000;
        }
        
        #goto-menu {
            left: 200px;
            background-color: rgb(48, 47, 47);
            color: white;
        }
        
        #reconnect-btn {
            right: 10px;
            background-color: #9E9E9E;
            color: white;
            display: none;
        }
        
        .controls-hidden { opacity: 0; transition: opacity 0.5s; }
        
        #welcome-message, .slide {
            transition: all 0.5s ease;
        }

        /* Estilos do contador de progresso */
        .slide-progress {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            z-index: 1000;
        }
        
        .progress-circle {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        
        .progress-circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 4;
        }
        
        .progress-circle-fill {
            fill: none;
            stroke: #2196F3;
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.1s linear;
        }
    </style>
</head>
<body>
    <!-- Interface simplificada -->
    <div id="status" class="status disconnected">Desconectado</div>
    <button id="reconnect-btn">Reconectar</button>

    <div id="department-selector">
        <div id="department-loading">Carregando departamentos...</div>
        <select id="department-select" style="display: none;"></select>
    </div>
    
    <button id="goto-menu">Menu</button>
    <button id="fullscreen-btn">TELA CHEIA</button>
    <div id="welcome-message">Seja bem-vindo!<br>Fique atento às nossas promoções</div>
    <div id="slider"></div>
    
    <!-- Contador de progresso circular -->
    <div class="slide-progress">
        <svg class="progress-circle" viewBox="0 0 36 36">
            <circle class="progress-circle-bg" cx="18" cy="18" r="16"></circle>
            <circle class="progress-circle-fill" cx="18" cy="18" r="16" stroke-dasharray="100 100" stroke-dashoffset="0"></circle>
        </svg>
    </div>

    <!-- Apenas STOMP.js necessário -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script>
        // ============= CONFIGURAÇÕES =============
        const serverAddress = window.location.hostname;
        const serverPort = window.location.port || '9090';
        const socketEndpoint = `ws://${serverAddress}:${serverPort}/ws-promotions`;
        const promotionsTopic = "/topic/promotions";
        const defaultImage = "https://cdn.pixabay.com/photo/2018/08/30/14/46/food-3642376_1280.jpg";

        // ============= ELEMENTOS DOM =============
        const elements = {
            status: document.getElementById('status'),
            menuBtn: document.getElementById('goto-menu'),
            slider: document.getElementById('slider'),
            reconnectBtn: document.getElementById('reconnect-btn'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            welcomeMessage: document.getElementById('welcome-message'),
            departmentSelect: document.getElementById('department-select'),
            departmentLoading: document.getElementById('department-loading'),
            progressCircle: document.querySelector('.progress-circle-fill')
        };

        // ============= ESTADO GLOBAL =============
        const state = {
            stompClient: null,
            currentSlide: 0,
            slideIntervalId: null,
            progressIntervalId: null,
            isFullscreen: false,
            selectedDepartment: null,
            activePromotionIds: new Set(),
            slideInterval: 8000, // 8 segundos
            hideDelay: 3000,
            mouseTimeout: null,
            timeLeft: 0,
            circumference: 2 * Math.PI * 16 // Circunferência do círculo (2πr)
        };

        // ============= FUNÇÕES PRINCIPAIS =============
        function formatDepartmentName(name) {
            return name.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                   .replace(/[^a-zA-Z\s]/g, '').toUpperCase();
        }

        function isPromotionValid(promotion) {
            if (!promotion.active) return false;
            if (!promotion.expirationDate) return true;
            return new Date() <= new Date(promotion.expirationDate);
        }

        function resetSlider() {
            document.querySelectorAll('.slide').forEach(slide => slide.remove());
            state.activePromotionIds.clear();
            elements.welcomeMessage.style.display = 'flex';
            state.currentSlide = 0;
            stopSlideShow();
        }

        async function loadDepartments() {
            try {
                const response = await fetch('/api/departments');
                if (!response.ok) throw new Error('Erro na API');
                
                const departments = await response.json();
                elements.departmentSelect.innerHTML = '';
                elements.departmentSelect.add(new Option('Todos os Departamentos', 'ALL'));
                
                departments.forEach(dept => {
                    const option = new Option(dept.departmentName, formatDepartmentName(dept.departmentName));
                    elements.departmentSelect.add(option);
                });

                elements.departmentLoading.style.display = 'none';
                elements.departmentSelect.style.display = 'block';
                state.selectedDepartment = elements.departmentSelect.value;

            } catch (error) {
                console.error('Erro ao carregar departamentos:', error);
                // Fallback básico
                elements.departmentSelect.innerHTML = `
                    <option value="ALL">Todos os Departamentos</option>
                    <option value="PADARIA">Padaria</option>
                    <option value="ACOUGUE">Açougue</option>
                `;
                elements.departmentLoading.style.display = 'none';
                elements.departmentSelect.style.display = 'block';
                state.selectedDepartment = "ALL";
            }
        }

        function showPromotionSlide(promotion) {
            if (!isPromotionValid(promotion)) return;

            const promoDept = formatDepartmentName(promotion.department.departmentName);
            const shouldShow = state.selectedDepartment === 'ALL' || promoDept === state.selectedDepartment;
            
            if (shouldShow && !state.activePromotionIds.has(promotion.id)) {
                state.activePromotionIds.add(promotion.id);
                elements.welcomeMessage.style.display = 'none';

                const slide = document.createElement('div');
                slide.className = 'slide';
                slide.dataset.promotionId = promotion.id;
                slide.style.backgroundImage = `url('${promotion.imageUrl || defaultImage}')`;
                
                slide.innerHTML = `
                    <div class="promotion-card">
                        <h2>${promotion.productName || 'Promoção'}</h2>
                        <p><strong>de R$:</strong> ${(promotion.originalPrice || 0).toFixed(2).replace('.', ',')}</p>
                        <p><strong>por R$:</strong> ${(promotion.promotionalPrice || 0).toFixed(2).replace('.', ',')}</p>
                        ${promotion.expirationDate ? `<p><strong>Válido até:</strong> ${new Date(promotion.expirationDate).toLocaleDateString('pt-BR')}</p>` : ''}
                    </div>
                `;

                elements.slider.appendChild(slide);
                
                if (document.querySelectorAll('.slide').length === 1) {
                    startSlideShow();
                    slide.classList.add('active');
                    state.currentSlide = 0;
                }
            }
        }

        // ============= WEBSOCKET =============
        function connect() {
            setStatus("connecting", "Conectando...");
            elements.reconnectBtn.style.display = 'none';

            if (state.stompClient && state.stompClient.connected) {
                state.stompClient.disconnect();
            }

            const socket = new WebSocket(socketEndpoint);
            state.stompClient = Stomp.over(socket);
            state.stompClient.debug = () => {};

            state.stompClient.connect({}, 
                () => {
                    setStatus("connected", `Conectado - ${new Date().toLocaleTimeString()}`);
                    elements.reconnectBtn.style.display = 'none';
                    loadExistingPromotions();

                    state.stompClient.subscribe(promotionsTopic, message => {
                        try {
                            const promotion = JSON.parse(message.body);
                            if (isPromotionValid(promotion)) {
                                showPromotionSlide(promotion);
                            }
                        } catch (e) {
                            console.error("Erro ao processar mensagem:", e);
                        }
                    });
                },
                (error) => {
                    console.error("Erro na conexão:", error);
                    setStatus("disconnected", "Falha na conexão");
                    elements.reconnectBtn.style.display = 'block';
                    setTimeout(connect, 5000);
                }
            );
        }

        // ============= FUNÇÕES AUXILIARES =============
        function setStatus(status, message) {
            elements.status.textContent = message;
            elements.status.className = `status ${status}`;
        }

        async function loadExistingPromotions() {
            try {
                const response = await fetch('/api/promotions');
                if (!response.ok) throw new Error('Erro ao carregar promoções');
                
                const promotions = await response.json();
                promotions.filter(promotion => isPromotionValid(promotion))
                         .forEach(promotion => showPromotionSlide(promotion));
            } catch (error) {
                console.error('Erro ao carregar promoções:', error);
            }
        }

        function updateProgressCircle(percent) {
            const offset = state.circumference - (percent / 100) * state.circumference;
            elements.progressCircle.style.strokeDashoffset = offset;
            
            // Muda a cor quando está perto de acabar
            if (percent < 20) {
                elements.progressCircle.style.stroke = '#f44336';
            } else {
                elements.progressCircle.style.stroke = '#2196F3';
            }
        }

        function startSlideShow() {
            if (!state.slideIntervalId) {
                // Configura o círculo de progresso
                elements.progressCircle.style.strokeDasharray = state.circumference;
                updateProgressCircle(100);
                state.timeLeft = state.slideInterval / 1000; // Converte para segundos
                
                // Atualiza o contador a cada 100ms
                state.progressIntervalId = setInterval(() => {
                    state.timeLeft -= 0.1;
                    const progress = (state.timeLeft / (state.slideInterval / 1000)) * 100;
                    updateProgressCircle(progress);
                }, 100);
                
                state.slideIntervalId = setInterval(() => {
                    updateSlideShow();
                    state.timeLeft = state.slideInterval / 1000; // Reseta o contador
                    updateProgressCircle(100);
                }, state.slideInterval);
            }
        }

        function updateSlideShow() {
            const slides = document.querySelectorAll('.slide');
            
            if (slides.length === 0) {
                elements.welcomeMessage.style.display = 'flex';
                stopSlideShow();
                return;
            }

            slides.forEach(slide => slide.classList.remove('active'));
            state.currentSlide = (state.currentSlide + 1) % slides.length;
            slides[state.currentSlide].classList.add('active');
        }

        function stopSlideShow() {
            if (state.slideIntervalId) {
                clearInterval(state.slideIntervalId);
                clearInterval(state.progressIntervalId);
                state.slideIntervalId = null;
                state.progressIntervalId = null;
                updateProgressCircle(100); // Volta ao completo
            }
        }

        function hideControls() {
            const controls = [
                elements.status,
                elements.reconnectBtn,
                elements.fullscreenBtn,
                elements.menuBtn,
                document.getElementById('department-selector'),
                document.querySelector('.slide-progress')
            ];
            
            controls.forEach(control => {
                if (control) control.classList.add('controls-hidden');
            });

            // Esconde o cursor do mouse
            document.body.classList.add('fullscreen-no-cursor');
        }

        // ============= FUNÇÕES DE TELA CHEIA =============

        function showControls() {
            const controls = [
                elements.status,
                elements.reconnectBtn,
                elements.fullscreenBtn,
                elements.menuBtn,
                document.getElementById('department-selector'),
                document.querySelector('.slide-progress')
            ];
            
            controls.forEach(control => {
                if (control) control.classList.remove('controls-hidden');
            });

            // Mostra o cursor do mouse
             document.body.classList.remove('fullscreen-no-cursor');
        }

        function handleMouseMove() {
            if (state.isFullscreen) {
                showControls();
                resetHideTimeout();
            }
        }

        function resetHideTimeout() {
            clearTimeout(state.mouseTimeout);
            state.mouseTimeout = setTimeout(() => {
                if (state.isFullscreen) {
                    hideControls();
                }
            }, state.hideDelay);
        }

        function enterFullscreenAutomatically() {
            // Só tenta entrar em tela cheia se não estiver já em fullscreen
            if (!state.isFullscreen) {
                document.documentElement.requestFullscreen()
                    .then(() => {
                        state.isFullscreen = true;
                          document.addEventListener('mousemove', handleMouseMove);
                              resetHideTimeout();
                                  hideControls(); // Esconde os controles após entrar em fullscreen
                      })    
                        .catch(err => {
                        console.log("Erro ao entrar em tela cheia automaticamente:", err);
                        // Em alguns navegadores, o fullscreen automático só funciona após interação do usuário
                        // Então marcamos para tentar novamente quando houver interação
                        document.addEventListener('click', tryFullscreenOnce, { once: true });
                    });
            }
        }

        function tryFullscreenOnce() {
            if (!state.isFullscreen) {
                enterFullscreenAutomatically();
            }
        }

        function toggleFullscreen() {
            if (!state.isFullscreen) {
                document.documentElement.requestFullscreen()
                    .then(() => {
                        state.isFullscreen = true;
                        document.addEventListener('mousemove', handleMouseMove);
                        resetHideTimeout();
                    })
                    .catch(err => {
                        console.error("Erro ao entrar em tela cheia:", err);
                    });
            } else {
                document.exitFullscreen();
            }
        }

        function showFullscreenPrompt() {
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '9999';
            overlay.style.color = 'white';
            overlay.style.fontSize = '2rem';
            overlay.style.textAlign = 'center';
            overlay.innerHTML = '<p>Clique para entrar em modo tela cheia e ver as promoções</p>';

            overlay.addEventListener('click', () => {
                overlay.remove();
                enterFullscreenAutomatically();
            });

            document.body.appendChild(overlay);
        }

// No event listener de load:
window.addEventListener('load', async () => {
    await loadDepartments();
    // ... resto da inicialização ...
        showFullscreenPrompt(); // Em vez de enterFullscreenAutomatically()
        });

        // ============= INICIALIZAÇÃO =============
        window.addEventListener('load', async () => {
            
            await loadDepartments();
            
            elements.departmentSelect.addEventListener('change', () => {
                state.selectedDepartment = elements.departmentSelect.value;
                resetSlider();
                if (state.stompClient?.connected) loadExistingPromotions();
            });

            elements.reconnectBtn.addEventListener('click', connect);
            elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
            elements.menuBtn.addEventListener('click', () => {
                window.location.href = '/promotions/list-promotions.html';
            });

            connect();

            // Tenta entrar em tela cheia automaticamente após um pequeno delay
            setTimeout(enterFullscreenAutomatically, 1000);
            
            // Verifica promoções expiradas a cada minuto
            setInterval(() => {
                document.querySelectorAll('.slide').forEach(slide => {
                    const expiration = slide.querySelector('p:last-child')?.textContent;
                    if (expiration) {
                        const [day, month, year] = expiration.match(/\d{2}\/\d{2}\/\d{4}/)[0].split('/');
                        if (new Date(`${year}-${month}-${day}`) < new Date()) {
                            slide.remove();
                        }
                    }
                });
            }, 60000);
        });

        document.addEventListener('fullscreenchange', () => {
            state.isFullscreen = !!document.fullscreenElement;
            if (!state.isFullscreen) {
                document.removeEventListener('mousemove', handleMouseMove);
                clearTimeout(state.mouseTimeout);
                showControls();
            }
        });
    </script>
</body>
</html>