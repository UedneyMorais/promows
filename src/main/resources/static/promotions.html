<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conexão WebSocket Básica</title>
    <!-- Bibliotecas necessárias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <h1>Teste de Conexão WebSocket</h1>
    <div id="status">Status: Desconectado</div>
    <button onclick="connect()">Conectar</button>
    <button onclick="disconnect()">Desconectar</button>
    <hr>
    <div>
        <h3>Mensagens recebidas:</h3>
        <ul id="messages"></ul>
    </div>

    <script>

        // Configurações Globais
        const socketEndpoint = `/ws-promotions`;
        const promotionsTopic = "/topic/promotions";

        // Variáveis para controlar a conexão
        let stompClient = null;
        
        // Função para conectar ao WebSocket
        function connect() {
            // 1. Criamos uma conexão SockJS apontando para o endpoint do Spring
            const socket = new SockJS(socketEndpoint);
            
            // 2. Criamos um cliente STOMP sobre essa conexão
            stompClient = Stomp.over(socket);
            
            // 3. Conectamos ao servidor
            stompClient.connect({}, 
            
                // Callback de sucesso
                function(frame) {
                    document.getElementById('status').textContent = 'Status: Conectado';
                    console.log('Conectado: ' + frame);
                    
                    // 4. Inscrevemos no tópico de promoções
                    stompClient.subscribe(promotionsTopic, function(message) {

                        // 5. Quando recebemos uma mensagem, processamos ela
                        const promotion = JSON.parse(message.body);
                        console.log('Mensagem recebida:', {
                            id: promotion.id,
                            nome: promotion.productName,
                            timestamp: new Date().toISOString(),
                            mensagemCompleta: promotion
                        });

                        // Adicionamos a mensagem à lista
                        const messagesElement = document.getElementById('messages');
                        const li = document.createElement('li');
                        li.textContent = `Nova promoção: ${promotion.productName} - De ${promotion.originalPrice} por ${promotion.promotionalPrice}`;
                        messagesElement.appendChild(li);
                    });
                },
                // Callback de erro
                function(error) {
                    document.getElementById('status').textContent = 'Status: Erro na conexão';
                    console.error('Erro ao conectar:', error);
                }
            );
        }
        
        // Função para desconectar do WebSocket
        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                stompClient = null;
                document.getElementById('status').textContent = 'Status: Desconectado';
                console.log('Desconectado');
            }
        }
    </script>
</body>
</html>